#!/bin/bash

# This file changes where things point for multi-version software.
# One of my more fancy-pants scripts... ;P
# Configure software to be prefixed with /usr/multi/$(soft)/$(ver).
# Then use this to switch things around. It works pretty well.

cd /usr/multi

help() {
	echo "Usage: $0 PROGRAM VERSION"
	echo "Or: $0 regen"
	echo "The following programs exist:"
	for p in *; do
		if [ ! "$p" = "multi_config" ]; then
			echo -n "   $p"
			cd "$p"

			echo -n " [ "
			for v in *; do
				if [ ! "$v" = "use" ]; then
					echo -n "$v "
				fi
			done
			echo "]"
			cd ..
		fi
	done
	exit 1
}

regen() {
	echo "Regenerating /etc/multi.env and /etc/ld.so.conf.d/00_multi_env.conf ..."

	cfg=/etc/multi.env

	rm /etc/multi.env
	rm /etc/ld.so.conf.d/00_multi_env.conf

	echo "# This file was automatically generated by fancy-pants scripts. Don't edit it." >> /etc/ld.so.conf.d/00_multi_env.conf
	echo "# This file was automatically generated by fancy-pants scripts. Don't edit it." >> $cfg

	for p in *; do
		if [ ! "$p" = "multi_config" ] && [ -f "${p}/use" ]; then
			echo "${p}_path=/usr/multi/${p}/$(cat ${p}/use)/bin" >> $cfg
			echo "${p}_libs=/usr/multi/${p}/$(cat ${p}/use)/lib" >> $cfg

			echo "/usr/multi/${p}/$(cat ${p}/use)/lib" >> /etc/ld.so.conf.d/00_multi_env.conf

			if [ -d "/usr/multi/${p}/$(cat ${p}/use)/lib64" ]; then
				echo "/usr/multi/${p}/$(cat ${p}/use)/lib64" >> /etc/ld.so.conf.d/00_multi_env.conf
				echo "${p}_libs=\$${p}_libs:/usr/multi/${p}/$(cat ${p}/use)/lib64" >> $cfg
			fi

			if [ -d "/usr/multi/${p}/$(cat ${p}/use)/lib32" ]; then
				echo "/usr/multi/${p}/$(cat ${p}/use)/lib32" >> /etc/ld.so.conf.d/00_multi_env.conf
				echo "${p}_libs=\$${p}_libs:/usr/multi/${p}/$(cat ${p}/use)/lib32" >> $cfg
			fi

			if [ -e "/usr/multi/${p}/$(cat ${p}/use)/extra.env" ]; then
				cat "/usr/multi/${p}/$(cat ${p}/use)/extra.env" >> $cfg
			fi

		fi
	done

	echo -n "export PATH=\"\$PATH" >> $cfg
	for p in *; do
		if [ ! "$p" = "multi_config" ] && [ -f "${p}/use" ]; then
			echo -n ":\$${p}_path" >> $cfg
		fi
	done
	echo "\"" >> $cfg

	echo -n "export LD_LIBRARY_PATH=\"\$LD_LIBRARY_PATH" >> $cfg
	for p in *; do
		if [ ! "$p" = "multi_config" ] && [ -f "${p}/use" ]; then
			echo -n ":\$${p}_libs" >> $cfg
		fi
	done
	echo "\"" >> $cfg
	
	echo "Running ldconfig..."

	ldconfig

	exit 0
}


if [ "$1" = "regen" ]; then
	regen
fi

if [ "$1" = "" ] || [ "$2" = "" ]; then
	help
fi


if [ -d "/usr/multi/$1" ]; then
	cd "$1"
	if [ -d "$2" ]; then
		if [ ! "$2" = "system" ]; then
			echo -n "$2" > use
		fi
	else
		echo "Not a valid version."
		echo "The following versions are valid:"
		for v in *; do
			echo "$v"
		done
		exit 2
	fi
	cd ..
else
	echo "No program with that name in multi."
	echo "The following programs exist:"
	for v in *; do
		echo "$v"
	done
	exit 3
fi

echo "Relinked program $1 to be version $2."

regen
